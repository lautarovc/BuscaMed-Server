<!DOCTYPE html>
<html>
<head>
	<title>Lectura de archivo</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	{% load static %}
	<script src="{% static 'js/jquery.csv.js'%}"></script>
</head>
<body>

	<p>
		<b>Seleccione un archivo .csv para cargar: </b>
	</p>
	<input type="file" id="fileName" name="fileName">
	<button onclick="readCSV()">Cargar archivo</button>

	<form method="post" action="">
		{% csrf_token %}
		<input type="hidden" id="csv" name="csv">
		<button type="submit" id="formButton" style="display: none;"></button>
	</form>

	<script>

		function checkData(data) {
			var firstRow = data[0]
			
			if (!("activo" in firstRow && "medicina" in firstRow && "presentacion" in firstRow && "disponibilidad" in firstRow)) {
				return false;
			}
			
			return true;
		}

		function readCSV() {
			var file = document.getElementById("fileName").files[0];
			
			// Revisamos que sea un archivo CSV.
			var fileType = file.name.split('.').pop();
			
			if (fileType != "csv") {
				// PONER AQUI MENSAJE DE ARCHIVO NO ES CSV
				alert("Error: File not .csv");
				return;
			}

			// Leemos archivo
			var reader = new FileReader();
      		reader.readAsText(file);

      		reader.onload = function(event){

      			// Cargamos texto del CSV y revisamos que separador tiene
	        	var csv = event.target.result;
	        	var firstLine = csv.split('\n').shift();

	        	if (firstLine.includes(";")) {
	        		var options = {"separator" : ";"};
	        	}
	        	else if (firstLine.includes(",")) {
	        		var options = {"separator" : ","};
	        	}
	        	else {
	        		alert("Error: check csv separator");
	        		return;
	        	}

	        	// Convertimos a arreglo de diccionarios
	        	var data = $.csv.toObjects(csv, options); 

	        	// Revisamos que tenga las columnas necesarias
	        	var dataIntegrity = checkData(data);

	        	if (!dataIntegrity) {
	        		// PONER AQUI MENSAJE DE ARCHIVO INADECUADO
	        		alert("Error: columns not correct");
	        		return;
	        	}

	        	// En caso contrario, convertimos a json string y enviamos
	        	var dataString = JSON.stringify(data);

	        	console.log(dataString);

	  			document.getElementById("csv").value = dataString;
	  			$('#formButton').click();
        	}
        	reader.onerror = function(){ alert('Unable to read ' + file.fileName); };
  		}
	</script>

</body>
</html>