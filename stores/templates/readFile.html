<!DOCTYPE html>
<html>
<head>
	<title>Lectura de archivo</title>
	{% load static %}
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" id="bootstrap-css">
	<link href="{% static 'css/common.css' %}" rel="stylesheet" type="text/css" />
	
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="{% static 'js/jquery.csv.js'%}"></script>

	<!-- file upload and toastr js -->
	<link href="{% static 'fileuploads/css/dropify.min.css' %}" rel="stylesheet" type="text/css" />
	<script src="{% static 'fileuploads/js/dropify.js' %}"></script>
</head>
{% block content %}
<body id="LoginForm">

<div class="container">
  <h1 class="form-heading">Buscamed Venezuela</h1>
  <div class="login-form">
    <div class="main-div">
      <div class="panel">
        <h2>Ingreso Inventario</h2>
        <p>Por favor seleccione el archivo .csv con el inventario a cargar:</p>
      </div>
      <form id="Login" method="post" action="">
      {% csrf_token %}

        <div class="form-group">
          	<input type="file" name="fileName" id="fileName" class="dropify" data-allowed-file-extensions="csv"> 
        </div>

		<input type="hidden" id="csv" name="csv">
		<button type="submit" id="formButton" style="display: none;"></button>

      </form>
	  <div class="forgot">
	    <a href="reset.html">Instrucciones</a>
	  </div>

	  <button onclick="readCSV()" class="btn btn-primary">Cargar archivo</button>

    </div>
    <p class="botto-text"> Designed by Sunil Rajput</p>
  </div>
</div>

<script>

	function checkData(data) {
		var firstRow = data[0]
		
		if (!("activo" in firstRow && "medicina" in firstRow && "presentacion" in firstRow && "disponibilidad" in firstRow)) {
			return false;
		}
		
		return true;
	}

	function readCSV() {
		var file = document.getElementById("fileName").files[0];
		
		// Revisamos que sea un archivo CSV.
		var fileType = file.name.split('.').pop();
		
		if (fileType != "csv") {
			// PONER AQUI MENSAJE DE ARCHIVO NO ES CSV
			alert("Error: File not .csv");
			return;
		}

		// Leemos archivo
		var reader = new FileReader();
  		reader.readAsText(file);

  		reader.onload = function(event){

  			// Cargamos texto del CSV y revisamos que separador tiene
        	var csv = event.target.result;
        	var firstLine = csv.split('\n').shift();

        	if (firstLine.includes(";")) {
        		var options = {"separator" : ";"};
        	}
        	else if (firstLine.includes(",")) {
        		var options = {"separator" : ","};
        	}
        	else {
        		alert("Error: check csv separator");
        		return;
        	}

        	// Convertimos a arreglo de diccionarios
        	var data = $.csv.toObjects(csv, options); 

        	// Revisamos que tenga las columnas necesarias
        	var dataIntegrity = checkData(data);

        	if (!dataIntegrity) {
        		// PONER AQUI MENSAJE DE ARCHIVO INADECUADO
        		alert("Error: columns not correct");
        		return;
        	}

        	// En caso contrario, convertimos a json string y enviamos
        	var dataString = JSON.stringify(data);

        	console.log(dataString);

  			document.getElementById("csv").value = dataString;
  			$('#formButton').click();
    	}
    	reader.onerror = function(){ alert('Unable to read ' + file.fileName); };
		}
</script>

<!-- dropify script -->
<script type="text/javascript">
    $('.dropify').dropify({
        messages: {
            'default': 'Drag and drop a file here or click',
            'replace': 'Drag and drop or click to replace',
            'remove': 'Remove',
            'error': 'Ooops, something wrong.'
        },
        error: {
            'fileSize': 'The file size is too big (1M max).'
        }
    });
</script>
</body>
{% endblock content %}
</html>